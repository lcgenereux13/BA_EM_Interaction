<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pagemaking Crew</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui'],
          }
        }
      },
      corePlugins: {
        preflight: true,
      },
      plugins: [require('@tailwindcss/typography')],
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/style.css">
</head>
  <body class="antialiased font-sans text-gray-800 bg-gray-50">
    <div class="flex flex-col h-screen">
    <header class="bg-blue-600 text-white py-4 px-6">
      <h1 class="text-xl font-semibold">Pagemaking Crew</h1>
    </header>
    <main class="flex flex-1 overflow-hidden">
      <div
        id="chat-container"
        class="w-[70%] flex flex-col relative"
      >
        <div id="chat" class="flex-1 overflow-y-auto px-4 py-6 space-y-4"></div>
        <div class="border-t px-4 py-3 bg-white sticky bottom-0 left-0 z-10">
          <textarea id="prompt" class="w-full border rounded p-2" rows="4" placeholder="Describe the research topic..."></textarea>
          <button id="start" type="button" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded">Start Crew</button>
        </div>
      </div>

      <div
        id="canvas"
        class="w-[30%] p-6 overflow-y-auto border-l bg-white"
      ></div>
    </main>
  </div>
<script>
const chatDiv = document.getElementById('chat');
const startBtn = document.getElementById('start');
const promptInput = document.getElementById('prompt');
const canvasDiv = document.getElementById('canvas');
let lastAgent = null;
let lastContent = null;
let currentRun = 0;
let previousDraft = null;
let jsonIndent = 0;
let diffTimer = null;

function appendToken(el, token) {
    const parts = token.split(/\n/);
    parts.forEach((part, idx) => {
        if (!part && idx === 0) return;

        if (idx > 0) {
            el.appendChild(document.createElement('br'));
        }

        for (const ch of part) {
            if (ch === '{' || ch === '[') {
                el.textContent += ch;
                jsonIndent++;
                el.appendChild(document.createElement('br'));
                el.textContent += ' '.repeat(jsonIndent * 2);
            } else if (ch === '}' || ch === ']') {
                jsonIndent = Math.max(0, jsonIndent - 1);
                el.appendChild(document.createElement('br'));
                el.textContent += ' '.repeat(jsonIndent * 2);
                el.textContent += ch;
                el.appendChild(document.createElement('br'));
                if (jsonIndent > 0) {
                    el.textContent += ' '.repeat(jsonIndent * 2);
                }
            } else if (ch === ',' && jsonIndent > 0) {
                el.textContent += ch;
                el.appendChild(document.createElement('br'));
                el.textContent += ' '.repeat(jsonIndent * 2);
            } else {
                const last = el.textContent.slice(-1);
                const needsSpace = last && !/\s/.test(last) && last !== '-' && !/^[.,!?;:]/.test(ch);
                el.textContent += (needsSpace ? ' ' : '') + ch;
            }
        }
    });
}

function renderDraft(draft) {
    canvasDiv.innerHTML = '';
    if (!draft) return;
    if (diffTimer) clearTimeout(diffTimer);
    canvasDiv.classList.add('draft');
    const bulletToString = (bullet) => {
        if (bullet == null) return '';

        let str;
        if (typeof bullet === 'string') {
            str = bullet;
        } else if (typeof bullet === 'object') {
            if ('text' in bullet) str = bullet.text;
            else if ('bullet' in bullet) str = bullet.bullet;
            else str = JSON.stringify(bullet);
        } else {
            str = String(bullet);
        }

        // strip common list markers like "-", "*", "•", or "1." from the start
        return str.replace(/^\s*(?:[-*•]|\d+[.)])\s*/, '').trim();
    };

    const diffText = (oldText, newText) => {
        if (oldText == null || oldText === newText) return newText || '';
        return `<s>${oldText}</s> <em>${newText}</em>`;
    };

    const title = document.createElement('h1');
    title.innerHTML = previousDraft ? diffText(previousDraft.title, draft.title || 'Untitled') : (draft.title || 'Untitled');
    canvasDiv.appendChild(title);

    const subtitle = document.createElement('h2');
    subtitle.innerHTML = previousDraft ? diffText(previousDraft.subtitle, draft.subtitle || '') : (draft.subtitle || '');
    canvasDiv.appendChild(subtitle);

    const oldSections = (previousDraft && previousDraft.sections) ? previousDraft.sections : [];
    (draft.sections || []).forEach((sec, i) => {
        const oldSec = oldSections[i] || {};
        const sTitle = document.createElement('p');
        sTitle.innerHTML = diffText(oldSec.section_title, sec.section_title);
        canvasDiv.appendChild(sTitle);
        const ul = document.createElement('ul');
        const newBullets = sec.section_bullets || [];
        const oldBullets = oldSec.section_bullets || [];
        const maxLen = Math.max(newBullets.length, oldBullets.length);
        for (let j = 0; j < maxLen; j++) {
            const li = document.createElement('li');
            const newB = newBullets[j] !== undefined ? bulletToString(newBullets[j]) : null;
            const oldB = oldBullets[j] !== undefined ? bulletToString(oldBullets[j]) : null;
            li.innerHTML = diffText(oldB, newB);
            ul.appendChild(li);
        }
        canvasDiv.appendChild(ul);
    });

    if (oldSections.length > (draft.sections || []).length) {
        for (let i = (draft.sections || []).length; i < oldSections.length; i++) {
            const oldSec = oldSections[i];
        const sTitle = document.createElement('p');
        sTitle.innerHTML = `<s>${oldSec.section_title}</s>`;
        canvasDiv.appendChild(sTitle);
            const ul = document.createElement('ul');
            (oldSec.section_bullets || []).forEach(b => {
                const li = document.createElement('li');
                li.innerHTML = `<s>${bulletToString(b)}</s>`;
                ul.appendChild(li);
            });
            canvasDiv.appendChild(ul);
        }
    }

    previousDraft = JSON.parse(JSON.stringify(draft));
    diffTimer = setTimeout(() => {
        canvasDiv.querySelectorAll('s, em').forEach(el => {
            const text = document.createTextNode(el.textContent);
            el.replaceWith(text);
        });
        canvasDiv.classList.remove('draft');
    }, 5000);
}

startBtn.addEventListener('click', async () => {
    chatDiv.innerHTML = '';
    lastAgent = null;
    lastContent = null;
    currentRun = 0;
    canvasDiv.innerHTML = '';
    const startResp = await fetch('/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptInput.value })
    });
    const { id } = await startResp.json();
    const evtSource = new EventSource('/stream/' + id);
    evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.agent === 'draft') {
            try {
                const draft = JSON.parse(data.token);
                renderDraft(draft);
            } catch {}
            return;
        }
        if (data.run !== currentRun) {
            currentRun = data.run;
            const runHeader = document.createElement('h3');
            runHeader.textContent = 'Run ' + currentRun;
            chatDiv.appendChild(runHeader);
            lastAgent = null;
            lastContent = null;
        }
        if (lastAgent !== data.agent) {
            lastAgent = data.agent;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message flex items-start space-x-2';
            if (data.agent === 'manager') msgDiv.classList.add('flex-row-reverse');
            const avatar = document.createElement('div');
            avatar.className = 'avatar w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold';
            avatar.style.background = data.agent === 'analyst' ? '#007bff' : '#6b21a8';
            avatar.textContent = data.agent === 'analyst' ? 'A' : data.agent === 'manager' ? 'M' : 'C';
            msgDiv.appendChild(avatar);
            const content = document.createElement('div');
            content.className = 'message-content whitespace-pre-wrap font-sans text-base leading-relaxed bg-gray-100 rounded px-3 py-2 max-w-[70%]';
            msgDiv.appendChild(content);
            chatDiv.appendChild(msgDiv);
            lastContent = content;
        }

        appendToken(lastContent, data.token);
        const isAtBottom = chatDiv.scrollHeight - chatDiv.scrollTop <= chatDiv.clientHeight + 20;
        if (isAtBottom) {
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }
    };
    evtSource.onerror = () => {
        evtSource.close();
    };
});
</script>
</body>
</html>
