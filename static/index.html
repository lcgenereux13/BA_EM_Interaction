<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Agent Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
        }

        #chat {
            max-height: 80vh;
            overflow-y: auto;
            margin-bottom: 1em;
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
        }
        .chat-message.agent1 {
            flex-direction: row;
        }
        .chat-message.agent2 {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 8px;
        }
        .agent1 .avatar {
            background: #007bff;
        }
        .agent2 .avatar {
            background: #28a745;
        }

        .message-content {
            background: #f1f1f1;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
<h1>Agent Chat</h1>
<div id="chat"></div>
<div style="margin-bottom:1em;">
    <input id="prompt" type="text" style="width: 80%;" />
    <button id="start" type="button">Start Crew</button>
</div>
<script>
const chatDiv = document.getElementById('chat');
const startBtn = document.getElementById('start');
const promptInput = document.getElementById('prompt');
let lastAgent = null;
let lastContent = null;
let currentRun = 0;

startBtn.addEventListener('click', async () => {
    chatDiv.innerHTML = '';
    lastAgent = null;
    lastContent = null;
    currentRun = 0;
    const evtSource = new EventSource('/stream?prompt=' + encodeURIComponent(promptInput.value));
    evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.run !== currentRun) {
            currentRun = data.run;
            const runHeader = document.createElement('h3');
            runHeader.textContent = 'Run ' + currentRun;
            chatDiv.appendChild(runHeader);
            lastAgent = null;
            lastContent = null;
        }
        if (lastAgent !== data.agent) {
            lastAgent = data.agent;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message ' + data.agent;
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = data.agent === 'analyst' ? 'A' : data.agent === 'manager' ? 'M' : 'C';
            msgDiv.appendChild(avatar);
            const content = document.createElement('div');
            content.className = 'message-content';
            msgDiv.appendChild(content);
            chatDiv.appendChild(msgDiv);
            lastContent = content;
        }
        lastContent.textContent += data.token + ' ';
        chatDiv.scrollTop = chatDiv.scrollHeight;
    };
    evtSource.onerror = () => {
        evtSource.close();
    };
});
</script>
</body>
</html>
