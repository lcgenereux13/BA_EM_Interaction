<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Agent Chat</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: auto;
        }

        #container {
            display: flex;
            gap: 20px;
        }

        #chat-container {
            width: 60%;
        }

        #chat {
            max-height: 80vh;
            overflow-y: auto;
            margin-bottom: 1em;
        }

        #canvas {
            width: 40%;
            border: 1px solid #ccc;
            padding: 10px;
            max-height: 80vh;
            overflow-y: auto;
            background: #fff;
            border-radius: 4px;
        }

        .chat-message {
            display: flex;
            align-items: flex-start;
            margin: 8px 0;
        }
        .chat-message.analyst {
            flex-direction: row;
        }
        .chat-message.manager {
            flex-direction: row-reverse;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin: 0 8px;
        }
        .analyst .avatar {
            background: #007bff;
        }
        .manager .avatar {
            background: #004085;
        }

        .message-content {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .chat-message.analyst .message-content {
            background: #f7f7f7;
        }
        .chat-message.manager .message-content {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
<h1>Agent Chat</h1>
<div id="container">
  <div id="chat-container">
      <div id="chat"></div>
      <div style="margin-bottom:1em;">
          <textarea id="prompt" style="width:100%;height:4em;" placeholder="Describe the research topic..."></textarea>
          <button id="start" type="button">Start Crew</button>
      </div>
  </div>
  <div id="canvas" class="draft copilotKitWindow"></div>
</div>
<script>
const chatDiv = document.getElementById('chat');
const startBtn = document.getElementById('start');
const promptInput = document.getElementById('prompt');
const canvasDiv = document.getElementById('canvas');
let lastAgent = null;
let lastContent = null;
let currentRun = 0;
let previousDraft = null;

function appendToken(el, token) {
    const parts = token.split(/\n/);
    parts.forEach((part, idx) => {
        if (idx > 0) el.appendChild(document.createElement('br'));
        if (!part) return;
        const last = el.textContent.slice(-1);
        const needsSpace = last && !/\s/.test(last) && !/^[.,!?;:]/.test(part);
        el.textContent += (needsSpace ? ' ' : '') + part;
    });
}

function renderDraft(draft) {
    canvasDiv.innerHTML = '';
    if (!draft) return;
    const bulletToString = (bullet) => {
        if (bullet == null) return '';
        if (typeof bullet === 'string') return bullet;
        if (typeof bullet === 'object') {
            if ('text' in bullet) return bullet.text;
            if ('bullet' in bullet) return bullet.bullet;
            return JSON.stringify(bullet);
        }
        return String(bullet);
    };

    const diffText = (oldText, newText) => {
        if (oldText == null || oldText === newText) return newText || '';
        return `<s>${oldText}</s> <em>${newText}</em>`;
    };

    const title = document.createElement('h2');
    title.innerHTML = previousDraft ? diffText(previousDraft.title, draft.title || 'Untitled') : (draft.title || 'Untitled');
    canvasDiv.appendChild(title);

    const subtitle = document.createElement('h4');
    subtitle.innerHTML = previousDraft ? diffText(previousDraft.subtitle, draft.subtitle || '') : (draft.subtitle || '');
    canvasDiv.appendChild(subtitle);

    const oldSections = (previousDraft && previousDraft.sections) ? previousDraft.sections : [];
    (draft.sections || []).forEach((sec, i) => {
        const oldSec = oldSections[i] || {};
        const sTitle = document.createElement('h3');
        sTitle.innerHTML = diffText(oldSec.section_title, sec.section_title);
        canvasDiv.appendChild(sTitle);
        const ul = document.createElement('ul');
        const newBullets = sec.section_bullets || [];
        const oldBullets = oldSec.section_bullets || [];
        const maxLen = Math.max(newBullets.length, oldBullets.length);
        for (let j = 0; j < maxLen; j++) {
            const li = document.createElement('li');
            const newB = newBullets[j] !== undefined ? bulletToString(newBullets[j]) : null;
            const oldB = oldBullets[j] !== undefined ? bulletToString(oldBullets[j]) : null;
            li.innerHTML = diffText(oldB, newB);
            ul.appendChild(li);
        }
        canvasDiv.appendChild(ul);
    });

    if (oldSections.length > (draft.sections || []).length) {
        for (let i = (draft.sections || []).length; i < oldSections.length; i++) {
            const oldSec = oldSections[i];
            const sTitle = document.createElement('h3');
            sTitle.innerHTML = `<s>${oldSec.section_title}</s>`;
            canvasDiv.appendChild(sTitle);
            const ul = document.createElement('ul');
            (oldSec.section_bullets || []).forEach(b => {
                const li = document.createElement('li');
                li.innerHTML = `<s>${bulletToString(b)}</s>`;
                ul.appendChild(li);
            });
            canvasDiv.appendChild(ul);
        }
    }

    previousDraft = JSON.parse(JSON.stringify(draft));
}

startBtn.addEventListener('click', async () => {
    chatDiv.innerHTML = '';
    lastAgent = null;
    lastContent = null;
    currentRun = 0;
    canvasDiv.innerHTML = '';
    const evtSource = new EventSource('/stream?prompt=' + encodeURIComponent(promptInput.value));
    evtSource.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.agent === 'draft') {
            try {
                const draft = JSON.parse(data.token);
                renderDraft(draft);
            } catch {}
            return;
        }
        if (data.run !== currentRun) {
            currentRun = data.run;
            const runHeader = document.createElement('h3');
            runHeader.textContent = 'Run ' + currentRun;
            chatDiv.appendChild(runHeader);
            lastAgent = null;
            lastContent = null;
        }
        if (lastAgent !== data.agent) {
            lastAgent = data.agent;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message ' + data.agent;
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = data.agent === 'analyst' ? 'A' : data.agent === 'manager' ? 'M' : 'C';
            msgDiv.appendChild(avatar);
            const content = document.createElement('div');
            content.className = 'message-content';
            msgDiv.appendChild(content);
            chatDiv.appendChild(msgDiv);
            lastContent = content;
        }

        appendToken(lastContent, data.token);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    };
    evtSource.onerror = () => {
        evtSource.close();
    };
});
</script>
</body>
</html>
